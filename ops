{"version":1,"ops":[{"type":3,"author":{"id":"b505cbb60ba651400190522029d45f8ed539d93a"},"timestamp":1602177276,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDcwNTcwODc0MQ==","github-url":"https://github.com/DFHack/stonesense/issues/73#issuecomment-705708741"},"message":"Are you sure that there isn't a crash? Is there any output after the final `[DFHack]#` prompt?","files":null},{"type":3,"author":{"id":"07d9db898a10c0bb99feb34de5773a76be20d790"},"timestamp":1602464993,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDcwNjgwMzQ1Nw==","github-url":"https://github.com/DFHack/stonesense/issues/73#issuecomment-706803457"},"message":"nothing indicated a crash, no output was produced. Might have been a quirk of the WM (xfwm), I tried quitting the Stonesense window on Windows 10 with no trouble.","files":null},{"type":3,"author":{"id":"b505cbb60ba651400190522029d45f8ed539d93a"},"timestamp":1602472759,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDcwNjgzMzM3NQ==","github-url":"https://github.com/DFHack/stonesense/issues/73#issuecomment-706833375"},"message":"Is it reproducible?\nGenerally these sorts of things are indeed crashes (i.e. Stonesense doesn't call `exit()` when things go wrong). In order to make sure you're not missing any output, I would recommend starting DFHack from an existing terminal session with `./dfhack` if you aren't already (as opposed to launching DFHack in a fresh terminal session that closes when DFHack exits). You could also check the end of `stderr.log` if you encounter a crash, although it would be unlikely to contain anything relevant.\n\nIf you have GDB installed, you could also run `./dfhack -g` to start with GDB attached, which would allow you to get a slightly more detailed backtrace.","files":null},{"type":3,"author":{"id":"07d9db898a10c0bb99feb34de5773a76be20d790"},"timestamp":1602793349,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDcwOTU2OTczNg==","github-url":"https://github.com/DFHack/stonesense/issues/73#issuecomment-709569736"},"message":"It does indeed appear to be a crash, it says Aborted. Sorry, I had somehow missed that before. I can also now say I've reproduced it on my own system (it was originally on a friends computer), with a different WM, so it's not related to that.\n\nThis is the output from running stonesense with dfhack with gdb attached.\n\n```\n[DFHack]# stonesense\n[New Thread 0x7fffd2271700 (LWP 2213)]\n[New Thread 0x7fffd1a70700 (LWP 2214)]\nStonesense launched\nUsing allegro version 5.0.10 r1\n[DFHack]# \n[New Thread 0x7fff93ebe700 (LWP 2215)]\n[New Thread 0x7fff936bd700 (LWP 2216)]\n[New Thread 0x7fff92ebc700 (LWP 2217)]\n[New Thread 0x7fff926bb700 (LWP 2218)]\n[New Thread 0x7fff7bddf700 (LWP 2219)]\n[New Thread 0x7fff7b59e700 (LWP 2220)]\n[Thread 0x7fff7b59e700 (LWP 2220) exited]\n[New Thread 0x7fff7b59e700 (LWP 2222)]\n[Thread 0x7fff7b59e700 (LWP 2222) exited]\nThread 9 \"Dwarf_Fortress\" received signal SIGSEGV, Segmentation fault.\n[Switching to Thread 0x7fffd1a70700 (LWP 2214)]\n__GI___libc_free (mem=0x2d2d2d2d2d2d2d2d) at malloc.c:3102\n3102    malloc.c: No such file or directory.\n```","files":null},{"type":3,"author":{"id":"b505cbb60ba651400190522029d45f8ed539d93a"},"timestamp":1602812157,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDcwOTY3NzMxMw==","github-url":"https://github.com/DFHack/stonesense/issues/73#issuecomment-709677313"},"message":"Looks like something is trying to free an uninitialized pointer. Does running `bt` in GDB at this point print anything?","files":null},{"type":3,"author":{"id":"07d9db898a10c0bb99feb34de5773a76be20d790"},"timestamp":1603292623,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDcxMzY0Mjk2Ng==","github-url":"https://github.com/DFHack/stonesense/issues/73#issuecomment-713642966"},"message":"This is running with dfhack r3, crash is reproduced the same. This is the output of `bt`\n\n```\n#0  __GI___libc_free (mem=0x2d2d2d2d2d2d2d2d) at malloc.c:3102\n#1  0x00007fffe009edbc in Tile::~Tile() () at ~/games/Dwarf Fortress/df_linux/hack/plugins/stonesense.plug.so\n#2  0x00007fffe011732f in stonesense_thread(ALLEGRO_THREAD*, void*) () at ~/games/Dwarf Fortress/df_linux/hack/plugins/stonesense.plug.so\n#3  0x00007fffdfdf092a in  () at ./hack/libs/liballegro.so.5.0\n#4  0x00007fffdfe2c26e in  () at ./hack/libs/liballegro.so.5.0\n#5  0x00007ffff605dea7 in start_thread (arg=\u003coptimized out\u003e) at pthread_create.c:477\n#6  0x00007ffff65f0d4f in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:95\n```","files":null},{"type":2,"author":{"id":"b505cbb60ba651400190522029d45f8ed539d93a"},"timestamp":1603294585,"metadata":{"github-id":"MDE3OlJlbmFtZWRUaXRsZUV2ZW50MzkwNDU5NzMwNg=="},"title":"Crash when closing the Stonesense window (Linux)","was":"Crash when closing the Stonesense window when a fort is loaded (Linux)"},{"type":5,"author":{"id":"b505cbb60ba651400190522029d45f8ed539d93a"},"timestamp":1603294588,"metadata":{"github-id":"MDEyOkxhYmVsZWRFdmVudDM5MDQ1OTc2MDM="},"added":["Crash"],"removed":[]},{"type":3,"author":{"id":"b505cbb60ba651400190522029d45f8ed539d93a"},"timestamp":1603294766,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDcxMzY2NjYxMg==","github-url":"https://github.com/DFHack/stonesense/issues/73#issuecomment-713666612"},"message":"Thanks! The backtrace points to https://github.com/DFHack/stonesense/blob/87e6cf02b914daf6f7811d967db6fadc7ca115fe/Tile.cpp#L175-L178\nThis doesn't look like it could crash by itself to me, which unfortunately likely means it's due to [something else in the Tile class](https://github.com/DFHack/stonesense/blob/87e6cf02b914daf6f7811d967db6fadc7ca115fe/Tile.h#L29-L103) getting corrupted.\n\nI was able to reproduce on Ubuntu, so I'll try to continue debugging there.","files":null},{"type":6,"author":{"id":"b505cbb60ba651400190522029d45f8ed539d93a"},"timestamp":1603294766,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6NDA4MzIyMzI3"},"target":"e1d207ea6aa29c6e740eeb276c7a1405d9a5bc287c4c2139d640d4001af34a08","message":"Thanks! The backtrace points to https://github.com/DFHack/stonesense/blob/87e6cf02b914daf6f7811d967db6fadc7ca115fe/Tile.cpp#L175-L178\nThis doesn't look like it could crash by itself to me, which unfortunately likely means it's due to [something else in the Tile class](https://github.com/DFHack/stonesense/blob/87e6cf02b914daf6f7811d967db6fadc7ca115fe/Tile.h#L29-L103) getting corrupted.\n\nI was able to reproduce on Ubuntu, so I'll try to continue debugging there.\n\nSide note: I was only able to reproduce when Stonesense is closed when a fort is loaded, so I've updated the title.","files":null},{"type":2,"author":{"id":"b505cbb60ba651400190522029d45f8ed539d93a"},"timestamp":1603294743,"metadata":{"github-id":"MDE3OlJlbmFtZWRUaXRsZUV2ZW50MzkwNDYxMDYwMQ=="},"title":"Crash when closing the Stonesense window when a fort is loaded (Linux)","was":"Crash when closing the Stonesense window (Linux)"},{"type":3,"author":{"id":"b505cbb60ba651400190522029d45f8ed539d93a"},"timestamp":1603298239,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDcxMzcwNDc3Ng==","github-url":"https://github.com/DFHack/stonesense/issues/73#issuecomment-713704776"},"message":"I was able to trace it to:\nhttps://github.com/DFHack/stonesense/blob/87e6cf02b914daf6f7811d967db6fadc7ca115fe/WorldSegment.h#L68\nhttps://github.com/DFHack/stonesense/blob/87e6cf02b914daf6f7811d967db6fadc7ca115fe/Tile.cpp#L211\n\nThe issue seems to be that Stonesense is calling the destructor explicitly, either multiple times on the same Tile object or on a Tile that was already deleted, because `building` contains a `c_sprite` object that was clearly already freed. Fixing this properly looks like it will require a deep knowledge of Stonesense, unfortunately, and I am not very familiar with it.","files":null},{"type":5,"author":{"id":"b505cbb60ba651400190522029d45f8ed539d93a"},"timestamp":1603298910,"metadata":{"github-id":"MDEyOkxhYmVsZWRFdmVudDM5MDQ5MzEzMzQ="},"added":["Bug"],"removed":[]},{"type":3,"author":{"id":"07d9db898a10c0bb99feb34de5773a76be20d790"},"timestamp":1603310559,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDcxMzg0MTM5MA==","github-url":"https://github.com/DFHack/stonesense/issues/73#issuecomment-713841390"},"message":"I'm not sure if I've ever seen something explicitly call a destructor before.  I assume the object is already free'd at the time of the crash so we can't check the valid state.","files":null},{"type":3,"author":{"id":"b505cbb60ba651400190522029d45f8ed539d93a"},"timestamp":1603316308,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDcxMzg5MjM1NQ==","github-url":"https://github.com/DFHack/stonesense/issues/73#issuecomment-713892355"},"message":"Yeah, I guess one option is moving the necessary cleanup code to a separate `Invalidate()` and just calling that instead. Right now, the only explicit code in the `Tile` destructor is `building.info = NULL;`, but I think it's also implicitly calling destructors of members, which is a problem when those are called twice. (The crash *always* occurs when I run DFHack under GDB, because that sets up `free()` to overwrite freed memory with `0x2d` - I suspect you're getting lucky on Windows and the relevant pointers end up being null.)","files":null}]}