{"version":1,"ops":[{"type":1,"author":{"id":"15c3f76112535b4a8bd51be5c03e11d2be4c0ca4"},"timestamp":1588921430,"metadata":{"github-id":"MDU6SXNzdWU2MTQ1NTAyMjc=","github-url":"https://github.com/DFHack/stonesense/issues/69","origin":"github"},"title":"Windows 10 : Stonesense crashes when resizing window","message":"Note: I have dual screens but I don't know if it's related.\n\n**Scenario :**\n- Start DF with DFHack\n- Start stonesense.\n**- You can resize stonesense window as long as it's in the splash screen**\n- Load a saved game\n- stonesense redraws the scene and everything works : scroll, change Z, etc.\n- With the mouse, maximize the stonesense window or simply resize it by dragging the corners (enlarge size or reduce size)\n**Expected :** The window gets resized properly\n**Observed (Faulty) :** Stonesense raises an exception (and crashes)\n\n**Details :** \n- The exception happens deep inside d3d9.dll\n\n`Unhandled exception at 0x00007FF8ACC54C15 (d3d9.dll) in Dwarf Fortress.exe: 0xC0000005: Access violation reading location 0x0000000000000088.\n`\n\nThe call stack is : \n\n        d3d9.dll!00007ff8acc54c15()\tUnknown\n        d3d9.dll!00007ff8acd3d59f()\tUnknown\n        d3d9.dll!00007ff8acd26993()\tUnknown\n        d3d9.dll!00007ff8acd188bd()\tUnknown\n        stonesense.plug.dll!_al_d3d_prepare_for_reset(struct ALLEGRO_DISPLAY_D3D *)\tUnknown\n        stonesense.plug.dll!_al_d3d_update_render_state()\tUnknown\n        stonesense.plug.dll!_al_d3d_update_render_state()\tUnknown\n        stonesense.plug.dll!al_set_clipping_rectangle()\tUnknown\n        stonesense.plug.dll!al_set_clipping_rectangle()\tUnknown\n        stonesense.plug.dll!al_draw_tinted_scaled_bitmap()\tUnknown\n        stonesense.plug.dll!WorldSegment::DrawAllTiles() Line 292\tC++\n        stonesense.plug.dll!paintboard() Line 1146\tC++\n        stonesense.plug.dll!main_loop(ALLEGRO_DISPLAY * display, Overlay * ovrlay, ALLEGRO_EVENT_QUEUE * queue, ALLEGRO_THREAD * main_thread, DFHack::color_ostream \u0026 con) Line 302\tC++\n        stonesense.plug.dll!stonesense_thread(ALLEGRO_THREAD * main_thread, void * parms) Line 558\tC++\n\nThe exception happens while calling this stonesense code : \n\n    al_draw_tinted_scaled_bitmap(\n        (ALLEGRO_BITMAP*) todraw[i].drawobject,\n        todraw[i].tint,\n        todraw[i].sx,\n        todraw[i].sy,\n        todraw[i].sw,\n        todraw[i].sh,\n        todraw[i].dx,\n        todraw[i].dy,\n        todraw[i].dw,\n        todraw[i].dh,\n        todraw[i].flags );\n\nPlease note : there doesn't seem to be any issue with any of the fields of todraw. Allegro compains internally, inside the Direct3D primitive. Maybe because it's drawing outside of the screen? The issue still happens when _enlarging_ the window.","files":null}]}